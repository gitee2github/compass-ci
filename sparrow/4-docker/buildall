#!/bin/bash -e

[[ $CCI_SRC ]] || export CCI_SRC=$(dirname $(dirname $(dirname $(realpath $0))))
CONTAINER_PATH="$CCI_SRC/container"

git checkout 0dd9b39f066a582626d4b3e7aeb6925c9ac83e7a

for dir in $CONTAINER_PATH/*
do
	[ -f "$dir"/Dockerfile ] || continue
	cur_dir=${dir##*/}
	(
	cd "$dir"
	[ "$cur_dir" == 'scheduler' ] && {
		echo "scheduler-dev first"
		exit
	}
	./build
	[ "$cur_dir" == 'debian' ] || \
	[ "$cur_dir" == 'lkp-initrd' ] || \
	[ "$cur_dir" == 'dracut-initrd' ] || \
	[ "$cur_dir" == 'crystal-base' ] || \
	[ "$cur_dir" == 'crystal-shards' ] || \
	[ "$cur_dir" == 'taskqueue' ] || \
	[ "$cur_dir" == 'shellcheck' ] && {
		echo "$cur_dir just build, skip!"
		exit
	}
	[ "$cur_dir" == 'scheduler-dev' ] && {
		cd "../scheduler"
		./build
		./run
		exit
	}
	[ "$cur_dir" == 'crystal-compiler' ] && {
		./install
		exit
	}
	./run
	)&
done
