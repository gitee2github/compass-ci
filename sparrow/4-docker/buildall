#!/bin/bash
# SPDX-License-Identifier: MulanPSL-2.0+
# Copyright (c) 2020 Huawei Technologies Co., Ltd. All rights reserved.

CONTAINER_PATH="$CCI_SRC/container"
export action=$1

[ -n "$LKP_SRC" ] && source "${LKP_SRC}/lib/log.sh"

build_depends()
{
	local container=$1

	for dep in $(cat $container/*-depends 2> /dev/null)
	do
		build_depends $CONTAINER_PATH/$dep &
	done
	wait

	do_one $container
}

do_one()
{
	local container=$1
	local container_name=$(basename $container)
	lockfile-create -q --use-pid --retry 100 --lock-name "$container_name".lock
	echo "$started_containers" | grep -w -q "$container_name" && return 0

	[ -n "$LKP_SRC" ] && log_info "start build $container."
	mkdir $tmpdir/$container_name 2>/dev/null &&
	(
		cd $container
		if [ "$action" != "reboot" ]; then
			[ -x build ] && ./build
			[ -x install ] && ./install
		fi
		[ -x first-run ] && ./first-run
		[ -x start ] && ./start
	)
	[ -n "$LKP_SRC" ] && log_info "finish build $container."
	started_containers+="$container_name"
	lockfile-remove --lock-name "$container_name".lock
}

tmpdir=$(mktemp -d)

for dir in $CONTAINER_PATH/*/
do
	build_depends $dir &
done
wait

rm -fr $tmpdir
