#!/bin/bash
# SPDX-License-Identifier: MulanPSL-2.0+
# Copyright (c) 2020 Huawei Technologies Co., Ltd. All rights reserved.

DIR=$(dirname $(realpath $0))
. $(dirname $DIR)/defconfig.sh

TAG=$1

load_cci_defaults

[[ $HOSTNAME == $lkp_pack_res_server ]] && [[ $USER == $lkp_pack_tag_user ]] || unset TAG

[[ -n $TAG ]] && {
	check_tag=$(git -C $LKP_SRC tag -l $TAG)
	if [[ -n $check_tag ]]
	then
		echo "Warning: Tag $TAG already exists."
		echo "It will rollback to it if you want to use it to do the package."
		echo -n "Continue(Y/y) or specify a new one(N/n): "
		read answer

		[[ $answer =~ ^[Nn] ]] && exit
		# case use an existing tag to do the pkg,
		# first roll back to the tag, and then do the pkg.
		git -C $LKP_SRC reset --hard $TAG
	else
		git -C $LKP_SRC tag $TAG
	fi
}

[[ $ARCH 	]] || ARCH=$(uname -m)
[[ $LKP_SRC	]] || LKP_SRC=/c/lkp-tests

cmd=(
	docker run
	--rm
	-e ARCH=$ARCH
	-e LKP_SRC=$LKP_SRC
	-v $LKP_SRC:$LKP_SRC
	-v $DIR/bin:/root/bin
	-v /srv/initrd/lkp/${lkp_initrd_user:-latest}:/osimage/user/lkp
	alpine:lkp
	/root/bin/pack-lkp.sh
)

"${cmd[@]}"

echo "result: /srv/initrd/lkp/${lkp_initrd_user:-latest}/lkp-${ARCH}.cgz"

# directory to store the base cgz is: /srv/upload-file/$repo_name/${ARCH}
[[ -n $TAG ]] && {
	repo_name=$(echo $LKP_SRC | awk -F'/' '{print $NF}')

	[[ -d "/srv/upload-files/$repo_name/${ARCH}" ]] || mkdir -p "/srv/upload-files/$repo_name/${ARCH}"
	cp "/srv/initrd/lkp/${lkp_initrd_user:-latest}/lkp-${ARCH}.cgz" "/srv/upload-files/$repo_name/${ARCH}/$TAG.cgz"
	echo "result: /srv/upload-files/$repo_name/${ARCH}/$TAG.cgz"

	# when doing the package with new tag, sync the base cgz to z9 server.
	rsync -aPz "/srv/upload-files/$repo_name/${ARCH}/$TAG.cgz" "${lkp_pack_tag_user}@${lkp_rsync_des_server}:/srv/upload-files/$repo_name/${ARCH}"
	echo "z9 result: :/srv/upload-files/$repo_name/${ARCH}/$TAG.cgz"
}

# rsync lkp-${ARCH}.cgz if needed
if [ -x /usr/local/bin/rsync-lkp-cgz ]; then
	/usr/local/bin/rsync-lkp-cgz "${lkp_initrd_user:-latest}" "${ARCH}"
fi

git -C $LKP_SRC pull > /dev/null
