#!/bin/bash
# SPDX-License-Identifier: MulanPSL-2.0+
# Copyright (c) 2020 Huawei Technologies Co., Ltd. All rights reserved.

DIR=$(dirname $(realpath $0))
. $(dirname $DIR)/defconfig.sh

TAG=$1

[[ -n $TAG ]] && {
	check_tag=$(git -C $LKP_SRC tag -l $TAG)
	if [[ -n $check_tag ]]
	then
		echo "TAG: $TAG already exists, please use a new one."
		exit 1
	fi
}

load_cci_defaults

[[ $ARCH 	]] || ARCH=$(uname -m)
[[ $LKP_SRC	]] || LKP_SRC=/c/lkp-tests

cmd=(
	docker run
	--rm
	-e ARCH=$ARCH
	-e LKP_SRC=$LKP_SRC
	-v $LKP_SRC:$LKP_SRC
	-v $DIR/bin:/root/bin
	-v /srv/initrd/lkp/${lkp_initrd_user:-latest}:/osimage/user/lkp
	alpine:lkp
	/root/bin/pack-lkp.sh $TAG
)

"${cmd[@]}"

echo "result: /srv/initrd/lkp/${lkp_initrd_user:-latest}/lkp-${ARCH}.cgz"
[[ -n $TAG ]] && {
	cp "/srv/initrd/lkp/${lkp_initrd_user:-latest}/lkp-${ARCH}.cgz" "/srv/initrd/lkp/$TAG-${ARCH}.cgz"
	echo "result: /srv/initrd/lkp/$TAG-${ARCH}.cgz"
}

# rsync lkp-${ARCH}.cgz if needed
if [ -x /usr/local/bin/rsync-lkp-cgz ]; then
	/usr/local/bin/rsync-lkp-cgz "${lkp_initrd_user:-latest}" "${ARCH}"
fi
