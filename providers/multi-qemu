#!/usr/bin/env ruby
# SPDX-License-Identifier: MulanPSL-2.0+
# frozen_string_literal: true

# Run multiple QEMU in parallel
HOSTNAME = "vm-pxe-hi1620-2p8g--#{ENV['USER']}"
NR_VM = 2

def run(seqno)
  loop do
    system(
      { 'hostname' => "#{HOSTNAME}-#{seqno}" },
      ENV['CCI_SRC'] + '/providers/qemu.sh'
    )
  end
end

def multiqemu
  NR_VM.times do |i|
    Process.fork do
      run i
    end
  end
end

multiqemu if $PROGRAM_NAME == __FILE__
